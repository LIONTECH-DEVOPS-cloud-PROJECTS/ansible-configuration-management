---
- name: Install Apache web server
  package:
    name: "{{ 'httpd' if ansible_os_family == 'RedHat' else 'apache2' }}"
    state: present
  tags: install

- name: Start and enable Apache service
  systemd:
    name: "{{ apache_service_name }}"
    state: started
    enabled: yes
  tags: service

- name: Create web directory
  file:
    path: "{{ web_app_directory }}"
    state: directory
    owner: "{{ web_user }}"
    group: "{{ web_group }}"
    mode: '0755'
  tags: setup

- name: Deploy LionTech welcome page
  template:
    src: index.html.j2
    dest: "{{ web_app_directory }}/index.html"
    owner: "{{ web_user }}"
    group: "{{ web_group }}"
    mode: '0644'
  tags: deploy

- name: Display firewall reminder for AWS
  debug:
    msg: |
      üîí FIREWALL REMINDER:
      Ensure your AWS Security Group allows inbound traffic on port {{ http_port }}
      You can manually add this rule in the AWS Console:
      - Protocol: TCP
      - Port: {{ http_port }}
      - Source: 0.0.0.0/0 (or your specific IP range)
  when: configure_firewall | default(true)
  tags: firewall

- name: Verify Apache is running
  command: "systemctl is-active {{ apache_service_name }}"
  register: apache_status
  changed_when: false
  tags: verify

- name: Verify web content is served
  uri:
    url: "http://localhost:{{ http_port }}"
    method: GET
    status_code: 200
    timeout: 10
  register: web_test
  ignore_errors: yes
  tags: verify

- name: Display deployment success message
  debug:
    msg: |
      üéâ SUCCESS: LionTech Application Deployed!
      ========================================
      Server: {{ ansible_hostname }}
      URL: http://{{ ansible_default_ipv4.address }}:{{ http_port }}
      Application: {{ web_app_name }}
      OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
      Apache Status: {{ apache_status.stdout }}
      Web Test: {{ "‚úÖ PASS" if web_test.status == 200 else "‚ö†Ô∏è  Check Security Group" }}
      
      üîí Next Steps:
      1. Check AWS Security Group allows port {{ http_port }}
      2. Access your app at: http://{{ ansible_default_ipv4.address }}
  tags: verify